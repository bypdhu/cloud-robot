# 发布流程配置

## 一、 准备工作

### 1. 基本信息

#### I. ansible 服务器地址：

    线下测试环境： 10.99.70.52 
    线上环境： 10.106.71.39；10.106.71.40

#### II. ansible playbook dir:
> 目前使用git进行管理，在playbook有更新时，需要手动到相应的ansible服务器更新

    线下测试环境： 
        基础目录： /root/ansible-test/playbook-common/
            发布目录： publish/
                playbook目录： playbooks/
                脚本目录： scripts/
            其他目录： collection/
    线上环境：
        正式发布：
            基础目录： /home/admin/conf/ansible_playbooks/publish_ansible/
                发布目录: publish/
                    playbook目录： playbooks/
                    脚本目录： scripts/
        其他：
            基础目录： /home/admin/conf/ansible_playbooks/playbook-common/
                测试发布目录: publish/
                    playbook目录： playbooks/
                    脚本目录： scripts/
                其他目录： collection/

#### III. ansbile 执行账户说明
> 线上使用统一的LDAP账户登录，zqtest(目前)， release_admin(以后)。
    
#### IIII. 增加ansible执行账户的权限（重要！！！）
> 根据操作类型，如发布、日志查询等，将相应的分组或者主机添加到相应的账户中。
  并且需要配置sudo免密码。

## 二、 编写playbook

### 1. 根据相应的流程编写相应的playbook
> 目前我们有一个可选流程任务，
    
    安装基础软件（可选），对应： install_many.yml

> 和两个默认固定流程任务。

    下载业务软件压缩包，对应： transfer_version.yml
    升级业务软件，对应： update_version.yml

### 2. 编写playbook需要注意（重要！！）

#### I. 执行task一般需要提升权限
    
    每一个task单独添加语句 =>    become： yes
    或者整体添加 => become: yes

#### II. 提升权限后，一般需要用admin身份执行，如
> (1) 创建一个文件夹
    
    - name: MAKE DIR
      become: yes
      file:
        path: /home/admin/publish/dir_for_test
        group: admin
        owner: admin
        state: directory
        
> (2) 执行一个脚本
  
    - name: RUN SCRIPT
      become: yes
      become_user: admin
      script: '{{ ansible_resource_dir }}/scripts/script_for_test.sh arg1 arg2'

## 三、 作业模板

### 1. 发布作业
> 不需要创建作业模板

### 2. 基础软件对比
> 不需要创建作业模板

### 3. 其他作业

#### I. 安装基础软件
> 对应一些基础操作，会在数据库提前配置相应的作业，主要配置playbook的路径

    数据库操作
        use jobsconf
        INSERT INTO `playbooks` (`playsn`, `playnm`, `playpath`, `parameters`, `created_time`) 
            VALUES ('12345001', '通用安装软件', 
                '/home/admin/conf/ansible_playbooks/playbook-common/collection/install_many.yml', 
                '{"app_list":[]}', now());

## 四、 流程模板

### 1. 现有流程模板

#### I. 目前有两种流程模板
> (1) 安装基础软件 -> 下载业务软件包1 -> 升级业务软件1

> (2) 下载业务软件包2 -> 升级业务软件2

#### II. 流程任务入参
> (1) 安装基础软件
 
        绑定作业中相应的模板，接收形式： {"apps_list":[]}
        
        例1 安装一个软件，app1（默认安装最新版本）： {"apps_list":["app1"]}
        例2 安装两个软件，app1的版本为5.02，app2不写版本： {"apps_list":["app1-5.02","app2"]}
        
> (2) 下载业务软件
 
    例1 接收参数形式及其key
    {
        "project": "jsbzb",
        "module": "esslog",
        "file_list": [{
            "file_url": "http://demo1.essintra.ejucloud.cn/jsbzbesslog_0.0.2_release.jar",
            "file_name": "jsbzbesslog_0.0.2_release.jar",
            "md5": "943005c3c72183ece2882f07827a9ac9"
        }],
        "host": "all",
        "version": "0.0.2",
        "build": "",
        "env": "release",
        "ansible_resource_dir": "/home/admin/conf/ansible_playbooks/playbook-common/publish"
    }
    
> (3) 升级业务软件
 
        同(2) 下载业务软件

#### III. 如果流程或者入参与默认不一致，则需要提出需求，编写新的流程模板
        
### 2. project层级（或者BU层级）第一次有发布需求

#### I. 可以使用当前模板时
> 如发布请求的BU的ID为“thisisbuid”，project为“测试项目”， module为“模块1”， 类型为“版本发布”， 
有一个通用模板ID为 “generalRelease:1:55012”可以满足发布需求，则 

    数据库选择
        use hanoi
        
    0) 查看现有的模板的bpmn_id的值
        select * from ACT_RE_PROCDEF;
        
    1) 添加BU可以通用的bpmn文件
        insert into tb_flow_templ (id, bpmn_id, bu_id, flow_name, module_id, module, project) 
            values ("4", "generalRelease:1:55012", "thisisbuid", "版本发布", "*", "*", "*");
            
    2) 添加project可以通用的bpmn文件
        insert into tb_flow_templ (id, bpmn_id, bu_id, flow_name, module_id, module, project) 
            values ("5", "generalRelease:1:55012", "thisisbuid", "版本发布", "*", "*", "测试项目");
            
    3) 添加确定BU/project/modu的bpmn文件
        insert into tb_flow_templ (id, bpmn_id, bu_id, flow_name, module_id, module, project) 
            values ("6", "generalRelease:1:55012", "thisisbuid", "版本发布", "*", "模块1", "测试项目");

#### II. 现有模板不能满足要求，则需要提出需求，编写新的流程模板。

    1) 根据需求整理出流程环节，编写相应的模板文件（bpmn格式）
    
    2) 数据库添加记录

### 3. project层级（或者BU层级）非首次有发布需求

#### I. 可以使用当前project或者BU的通用模板时
> 不需要任何配置，确认project或者Bu已经配置过通用模板即可。

#### II. 流程与通用模板不一致时，则需要提出需求，编写新的流程模板

###　4. 流程模板更新
> 当流程模板更新时，受到影响的发布等流程需要确认是否需要更新

    1) 不需要更新时，不需要配置，使用以前版本的流程模板
    
    2) 需要更新为新的模板时，目前可以手动配置更改
       如前例中，BU的ID为“thisisbuid”，project为“测试项目”， module为“模块1” 需要的模板更新为 generalRelease:2:65012，
       而其他需要的模板不变化，可以只更新需要的数据库记录：
            update tb_flow_templ set bpmn_id="generalRelease:2:65012" where id="6";
            
## 五、 发布流程

### 1. 根据发布编号查询流程
    
    数据库操作    
        db.releases.find({"sn":"20170630-150147-5597"});
