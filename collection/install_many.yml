---

- hosts: all
  gather_facts: no
  become: yes

  tasks:
  - name: 0. Check the date on the host.
    command: date

  - name: 1. make yum.repos.d backup dir
    file:
      path: /etc/yum.repos.d/backup
      group: root
      owner: root
      state: directory

  - name: 2. download internal yum repo file
    get_url:
      url: http://10.106.71.5/centos/CentOS-EJU.repo
      dest: /etc/yum.repos.d/CentOS-EJU.repo
      checksum: "md5:6b61f40741ab8f4f28f95a5535b9901e"
      owner: root
      group: root
      force: no

  - name: 3. move repo files to backup dir
    copy:
      remote_src: True
      src: {{ item }}
      dest: /etc/yum.repos.d/backup
    with_fileglob:
      - /etc/yum.repos.d/*


  - name: 4. stat internal repo file
    stat:
      path: /etc/yum.repos.d/CentOS-EJU.repo
    register: repo_stat

  - name: 5. Move internal repo file to yum.repo.d
    copy:
      remote_src: True
      src: /etc/yum.repos.d/backup/CentOS-EJU.repo
      dest: /etc/yum.repos.d/CentOS-EJU.repo
    when: repo_stat.stat.exists

  - name: 6. install many software
    yum: name={{ item }} state=present
    with_items: "{{ apps_list }}"

#  - name: get apps.
#    delegate_to: localhost
#    shell: echo {{ apps_name_version }} | awk -F, '{print $1"\n"$2}'
#    register: apps_list
#    ignore_errors: True

  - name: 7. check apps installed but ignore error
    shell: yum info {{ item }} | grep Installed
    with_items: "{{ apps_list }}"
    ignore_errors: True
